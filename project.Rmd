---
title: "project"
author: "Arianna Schmid, Stacey Frank"
date: "10/18/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## SETUP
``` {r echo = FALSE}
library(xml2)
library(rvest)
library(jsonlite)
library(robotstxt)
library(RSocrata)
library(tidyverse)
library(magrittr)
library(gtrendsR)
```

``` {r}
# scraping educated questions from cdc website
paths_allowed("https://www.cdc.gov/coronavirus/2019-ncov/vaccines/faq.html")
url <- read_html("https://www.cdc.gov/coronavirus/2019-ncov/vaccines/faq.html")  
nds <- html_nodes(url, xpath = '//*[contains(concat( " ", @class, " " ), concat( " ", "btn-link", " " ))]//span')
common <- html_text(nds)
common # scraped unnecessary contact info for cdc. Only need 1st 30 elements
common <- common[1:30] # the result is a list of 30 educated/common vaccine questions

# scraping myths/uneducated questions from cdc website
myths <- read_html("https://www.cdc.gov/coronavirus/2019-ncov/vaccines/facts.html") %>%
  html_nodes(xpath = '//*[(@id = "accordion-2-card-4")]//span | //*[(@id = "accordion-2-card-3")]//span |    //*[(@id = "accordion-2-card-2")]//span | //*[(@id = "accordion-2-card-1")]//span | //*[contains(concat( " ", @class, " " ), concat( " ", "h4", " " ))]//strong') %>% 
  html_text()
  myths # the result is a list of 11 uneducated questions/myths
  
  
# clean the lists:remove stopwords, turn into lowercase, remove blank space, and add + sign to set up for gtrends search afterwards
myths = tolower(myths)
all_stops <- c(stopwords("en"), "can","will","near","get","united states","use", "like")
myths_clean <- removeWords(myths,all_stops)
myths_clean %<>% str_trim()
myths_clean <- gsub("\\s+"," + ", myths_clean)
myths_clean
  
```

```{r}
# will the keywords below capture searches like "will the covid-19 vaccine damage my dna" and other variants of that question? or do I remove the addition sign?
#Info about keyword searches: https://github.com/PMassicotte/gtrendsR/issues/268

us <- gtrends(c("covid vaccine DNA"), geo = "US", 
               time = "2021-05-1 2021-06-29", low_search_volume = T)
plot(us) 
str(us)
us_time <- us$interest_over_time %>%
      as_tibble()
glimpse(us_time)
```

```{r}
#hits for search keyword by state
us_state <- us$interest_by_region %>%
      as_tibble()
glimpse(us_state)

#hits for search keyword by metro area
us_metro <- us$interest_by_dma %>%
      as_tibble()

#hits for search keyword by city
us_city <- us$interest_by_city %>%
      as_tibble()
```


```{r}
##Use RSocrata to pull down CDC COVID vaccine data using their API
##Dataset information available here: https://dev.socrata.com/foundry/data.cdc.gov/unsk-b7fc
##https://data.cdc.gov/Vaccinations/COVID-19-Vaccinations-in-the-United-States-Jurisdi/unsk-b7fc

cdc.df <- read.socrata(
  "https://data.cdc.gov/resource/unsk-b7fc.json",
  app_token = "vUEGablI1SjS2eGix6O89iNgH",
  email     = "stacey.m.frank@gmail.com",
  password  = "fN7E27&3K0Uf"
)
```


```{r}
##Data formatting/cleaning for CDC dataset

str(cdc.df)

apply(is.na(cdc.df), 2, sum)

cdc.df <- cdc.df %>% 
     mutate_at(c(4:80), as.numeric)

cdc.df$mmwr_week <- as.numeric(cdc.df$mmwr_week)

str(cdc.df)

apply(is.na(cdc.df), 2, sum)
```


```{r}
#Drop rows for territories and federal entities; only retain 50 states and Washington, DC (Google trends only has data for these entities)

table(cdc.df$location)


attach(cdc.df)
cdc.df.50 <-  cdc.df[ which (location!= "BP2" & location!= "DD2" & location!= "GU" & location!= "IH2" & location!= "LTC" & location!= "MH" & location!= "AS" & location!= "FM" & location!= "MP" & location!= "RP" & location!= "US" & location!= "VA2" & location!= "VI" & location!= "PR"),]
detach(cdc.df)

table(cdc.df.50$location)
```


```{r}
#Recode responses in CDC location variable so it matches the format used in Google Trends data, in preparation for joining datasets

cdc.df.50$location[cdc.df.50$location == "AK"] <- "Alaska"
cdc.df.50$location[cdc.df.50$location == "AL"] <- "Alabama"
cdc.df.50$location[cdc.df.50$location == "AR"] <- "Arkansas"
cdc.df.50$location[cdc.df.50$location == "AZ"] <- "Arizona"
cdc.df.50$location[cdc.df.50$location == "CA"] <- "California"
cdc.df.50$location[cdc.df.50$location == "CO"] <- "Colorado"
cdc.df.50$location[cdc.df.50$location == "CT"] <- "Connecticut"
cdc.df.50$location[cdc.df.50$location == "DC"] <- "District of Columbia"
cdc.df.50$location[cdc.df.50$location == "DE"] <- "Delaware"
cdc.df.50$location[cdc.df.50$location == "FL"] <- "Florida"
cdc.df.50$location[cdc.df.50$location == "GA"] <- "Georgia"
cdc.df.50$location[cdc.df.50$location == "HI"] <- "Hawaii"
cdc.df.50$location[cdc.df.50$location == "IA"] <- "Iowa"
cdc.df.50$location[cdc.df.50$location == "ID"] <- "Idaho"
cdc.df.50$location[cdc.df.50$location == "IL"] <- "Illinois"
cdc.df.50$location[cdc.df.50$location == "IN"] <- "Indiana"
cdc.df.50$location[cdc.df.50$location == "KS"] <- "Kansas"
cdc.df.50$location[cdc.df.50$location == "KY"] <- "Kentucky"
cdc.df.50$location[cdc.df.50$location == "LA"] <- "Louisiana"
cdc.df.50$location[cdc.df.50$location == "MA"] <- "Massachusetts"
cdc.df.50$location[cdc.df.50$location == "MD"] <- "Maryland"
cdc.df.50$location[cdc.df.50$location == "ME"] <- "Maine"
cdc.df.50$location[cdc.df.50$location == "MI"] <- "Michigan"
cdc.df.50$location[cdc.df.50$location == "MN"] <- "Minnesota"
cdc.df.50$location[cdc.df.50$location == "MO"] <- "Missouri"
cdc.df.50$location[cdc.df.50$location == "MS"] <- "Mississippi"
cdc.df.50$location[cdc.df.50$location == "MT"] <- "Montana"
cdc.df.50$location[cdc.df.50$location == "NC"] <- "North Carolina"
cdc.df.50$location[cdc.df.50$location == "ND"] <- "North Dakota"
cdc.df.50$location[cdc.df.50$location == "NE"] <- "Nebraska"
cdc.df.50$location[cdc.df.50$location == "NH"] <- "New Hampshire"
cdc.df.50$location[cdc.df.50$location == "NJ"] <- "New Jersey"
cdc.df.50$location[cdc.df.50$location == "NM"] <- "New Mexico"
cdc.df.50$location[cdc.df.50$location == "NV"] <- "Nevada"
cdc.df.50$location[cdc.df.50$location == "NY"] <- "New York"
cdc.df.50$location[cdc.df.50$location == "OH"] <- "Ohio"
cdc.df.50$location[cdc.df.50$location == "OK"] <- "Oklahoma"
cdc.df.50$location[cdc.df.50$location == "OR"] <- "Oregon"
cdc.df.50$location[cdc.df.50$location == "PA"] <- "Pennsylvania"
cdc.df.50$location[cdc.df.50$location == "RI"] <- "Rhode Island"
cdc.df.50$location[cdc.df.50$location == "SC"] <- "South Carolina"
cdc.df.50$location[cdc.df.50$location == "SD"] <- "South Dakota"
cdc.df.50$location[cdc.df.50$location == "TN"] <- "Tennessee"
cdc.df.50$location[cdc.df.50$location == "TX"] <- "Texas"
cdc.df.50$location[cdc.df.50$location == "UT"] <- "Utah"
cdc.df.50$location[cdc.df.50$location == "VA"] <- "Virginia"
cdc.df.50$location[cdc.df.50$location == "VT"] <- "Vermont"
cdc.df.50$location[cdc.df.50$location == "WA"] <- "Washington"
cdc.df.50$location[cdc.df.50$location == "WI"] <- "Wisconsin"
cdc.df.50$location[cdc.df.50$location == "WV"] <- "West Virginia"
cdc.df.50$location[cdc.df.50$location == "WY"] <- "Wyoming"

table(cdc.df.50$location)

```


```{r}
#visualize doses administered over time for entire US

cdc.df.50 %>%
  group_by(date) %>%
  summarize(administered = sum(administered)) %>%
  ggplot() +
  geom_line(mapping = aes(x = date, y = administered))

```


```{r}
##Create two datasets for our vaccination dates of interest

vax.June30 <- cdc.df.50 %>%
  filter(date == "2021-06-30")

vax.Sept21 <- cdc.df.50 %>%
  filter(date == "2021-09-21")

```